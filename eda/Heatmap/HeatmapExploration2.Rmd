---
title: "Heat Map Exploration"
author: "Rebecca Reus"
date: "August 5, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(sp)
library(ggmap)
library(tidyr)
library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)
library(readr)
library(maps)
library(mapdata)
library(rgdal)
library(rgeos)
#library(gpclib)       # loads polygon clipping library
library(maptools)     # loads sp library too
library(RColorBrewer) # creates nice color schemes
library(classInt)     # finds class intervals for continuous variables
library(gdata)
library(XLConnect)
library(data.table)
```

### Set data file names:
```{r}
# data file names:
data_file <- "../../clean_data/StopData_merged2.rds" # use the cleaned version of StopData_merged.rds for plotting. See StopData_clean_merged_rds.R for more information.
census_tract_folder <- "../../raw_data/Census_Tract_Polygons2010"
census_tract_shp <- "Census_tracts_2010"
census_tract_csv <- "../../raw_data/Census_tracts_2010.csv"
alameda_xls <- "../../raw_data/2010_Pop_Block_County.xls"
alameda_tract_nums_xls <- "../../raw_data/census_tract_numbers.xls"

```

### Read in the data:
```{r}
# read in the data to modify:
df <- readRDS( data_file )
wb <- loadWorkbook(alameda_xls)
alameda <- readWorksheet(wb, sheet=1,startRow = 5) 
```

### Get some location info from the data:
```{r}
# Location info (to set lim values for coordinates):
latmax <- max( df$lat, na.rm = TRUE )
latmin <- min( df$lat, na.rm = TRUE )
lonmax <- max( df$long, na.rm = TRUE )
lonmin <- min( df$long, na.rm = TRUE )
latvals <- c( latmin, latmax )
lonvals <- c( lonmin, lonmax )
```

### Get the regular Berkeley map:
```{r}
# get the plain Berkeley map from Google:
berkMap = map = get_map(location = c( lon = mean(lonvals), lat = mean(latvals) ), zoom = 12)
```

### Draw the regular Berkeley Map:
```{r}
ggmap(berkMap)
```


### Get the census shape files:
```{r}
##locationCensusFiles <- "C:/Users/Rebecca/Dropbox/School/2016_su_School/stat133/finalproject_angry_ladies/Rebeccas_location_Code2/Census_Block_Group_Polygons2010"
#blocks <- readOGR("Census_Block_Group_Polygons2010","Census_blockgroups_2010", verbose = TRUE)
census <- readOGR(census_tract_folder,census_tract_shp, verbose = TRUE)

# blocks.polygons <- blocks@polygons
# blocks.data <- blocks@data
# blocks.plot.order <- blocks@plotOrder
censusT <- spTransform(census, CRS("+proj=longlat +datum=WGS84"))
censusT@data$ID <- as.numeric(censusT@data$ID)
censusTfortified <- fortify(censusT)
#census4 <- census2@data
#pop <- census4$TotalPop
# census3 <- census3 %>%
#   mutate(id = as.factor(id))
# popdf <- as.vector(data.frame(id = as.character(unique(census3$id)), pop = as.character(pop), stringsAsFactors = FALSE, mode = "list" ))
# census5 <- merge(census3, popdf, by = id)

censusCSV <- read.csv(file=census_tract_csv, header = TRUE)

#census3 <- fortify(census2)
censusTmergedCSV <- merge(censusT, censusCSV, by='ID')


# census4$id <- 0:32
# census5 <- merge(census3, census4, by='id')
```

### Trying some things:
```{r}
# library(rgdal)     # R wrapper around GDAL/OGR
# library(ggplot2)   # for general plotting
# library(ggmaps)    # for fortifying shapefiles

# First read in the shapefile, using the path to the shapefile and the shapefile name minus the
# extension as arguments
# Next the shapefile has to be converted to a dataframe for use in ggplot2
shapefile_df <- fortify(censusT)

# Now the shapefile can be plotted as either a geom_path or a geom_polygon.
# Paths handle clipping better. Polygons can be filled.
# You need the aesthetics long, lat, and group.

```

```{r}
ggmap(berkMap) +
geom_path(data = shapefile_df, 
          aes(x = long, y = lat, group = group),
          color = 'black', size = .2) 
```


```{r}
ggmap(berkMap) +
geom_polygon(data = shapefile_df, 
          aes(x = long, y = lat, group = group),
          color = 'black', size = .2) 
```


### Ditch the axes theme:
```{r}
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )
```

### WORKs:
```{r}
# READ IN DATA RIGHT!!!
census.df <- fortify(census2, region = 'GEOID10')
pop <- read.csv(file=census_tract_csv, header = TRUE)
names(pop)[13] <- "id"
pop <- pop %>%
  select(GEOID10, id, TotalPop) %>% 
  mutate( id = str_c("0", as.character(id)) ) 
census.df_pop <- left_join(census.df, pop, by = "id")
```

```{r}
popdenmap <- ggmap(berkMap) + 
  geom_polygon(data = census.df_pop, aes(x = long, y = lat, group = group, fill = TotalPop), color = "white", alpha = .7) 
popdenmap
```

```{r}
popdenmap <- popdenmap + theme_bw()
```


```{r}
popdenmap  +
  coord_fixed(1.3) 
```

```{r}
popdenmap <- popdenmap +
  ditch_the_axes 
popdenmap
```

```{r}
popdenmap + scale_fill_gradient(trans = "log10")
```

```{r}
popamts <- censusCSV$TotalPop
popmin <- min(popamts)
popmin
popmax <- max(popamts)
popmax

#popints <- diff(range(popamts))

popints <- (popamts - min(popamts))/diff(range(popamts)) # recorts the percentage difference from the minimum population

popints_df 


```

```{r}
pd2 <- elbow_room1 + 
    scale_fill_gradientn(colours = rev(rainbow(7)),
                         breaks = c(2, 4, 10, 100, 1000, 10000),
                         trans = "log10") 
pd2
```



### All BPD Stops Density, 2015-2016
```{r}
# a contour plot
ggmap(berkMap) +
  stat_density2d(aes(x = long, y = lat, fill= ..level.., alpha = .2* ..level..),
                 size = 2, bins = 5, data = df, geom = "polygon") +
  scale_fill_gradient(low = "black", high = "red") +
  theme (panel.grid.major = element_blank (), # remove major grid
         panel.grid.minor = element_blank ()  # remove minor grid
  )+ 
  ggtitle("All BPD Stops Density, 2015-2016") +
  labs(alpha = element_blank())+
  guides(alpha = FALSE)

```

### Works, but no google maps:
```{r}
### Read in .shp file only for Census:
shpfile <- str_c(census_tract_folder, "/", census_tract_shp, ".shp")
sh <- readShapePoly(shpfile)
```

```{r}
### Plot the census shape file (polygon outline only)
plot(sh)
```

```{r}
### Modify the shape file to plot the population info:
sh@data$ID <- as.numeric(sh@data$ID)

# Read in the demographic data and merge on Neighbourhood Id
census5_2 <- read.csv(file=census_tract_csv, header = TRUE)
sh2 <- merge(sh, census5_2, by='ID')

# Set the palette
p <- colorRampPalette(c("white", "red"))(128)
palette(p)

# Scale the total population to the palette
popamts <- sh2@data$TotalPop.x

# create the colors:
cols <- (popamts - min(popamts))/diff(range(popamts))*127+1
```

```{r}
### Plot the census shape data with colors for population:
plot(sh, col=cols)
```

### Dealing with population info:
```{r}
#write.csv(alameda, file = "alameda_population_by_tract.csv")
alameda = alameda[-1,]
rownames(alameda) <- 1:nrow(alameda)
names(alameda)[1] <- "GEO"

alameda2 <- alameda %>%
  separate(GEO, c("Block","Group", "Tract", "County", "State"), ", ")

names(alameda2)[3] <- "NAME10"

alameda2 <- alameda2 %>%
  mutate(NAME10 = str_replace(NAME10, "Census Tract ", ""))

alameda2 <- alameda2 %>%
  select(-Block,-Group,-County,-State) 

a3 <- alameda2 %>%
        group_by(NAME10)%>% 
        summarise(Total.population = sum(Total.population),
                  Hispanic.or.Latino = sum(Hispanic.or.Latino),
                  Total.population..not.Hispanic.or.Latino = sum(Total.population..not.Hispanic.or.Latino),
                  One.race.total = sum(One.race.total),
                  White = sum(White),
                  American.Indian.and.Alaska.Native = sum(American.Indian.and.Alaska.Native),
                  Asian = sum(Asian),
                  Native.Hawaiian.and.Other.Pacific.Islander = sum(Native.Hawaiian.and.Other.Pacific.Islander),
                  Some.Other.Race = sum(Some.Other.Race),
                  Two.or.More.Races = sum(Two.or.More.Races))


#census_alameda <- left_join(censusCSV, a3, by = "NAMELSAD10")
```

```{r}
# READ IN DATA RIGHT!!!
census.df <- fortify(census2, region = 'NAME10')
pop <- censusCSV
pop <- pop %>%
  select(NAME10, TotalPop) %>%
  mutate(NAME10 = as.character(NAME10))

names(a3)[1] <- "id"
names(pop)[1] <- "id"

pop <- left_join(pop, a3, by = "id")
census.df <- left_join(census.df, pop, by = "id")
write.csv2(a3,"alameda_clean_census.csv")
write.csv2(pop, "berkeley_census_clean.csv")
```

```{r}
popdenmap <- ggmap(berkMap) + 
  geom_polygon(data = census.df, aes(x = long, y = lat, group = group, fill = TotalPop), color = "white", alpha = .7) 
popdenmap
```